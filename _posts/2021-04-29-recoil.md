---
title: åˆè¯†Recoil
date: 2021-04-29
categories: note
---

*Recoilä½œä¸ºåœ¨ã€ŠReact Europe 2020 Conferenceã€‹ä¸Šï¼ŒFacebookå†…éƒ¨é‡Šå‡ºçš„çŠ¶æ€ç®¡ç†åº“ï¼Œæˆ‘æƒ³å¾ˆå¤šäººå¯¹æ­¤éƒ½æ˜¯å……æ»¡å…´è¶£çš„ï¼Œæ‰€ä»¥èŠ±äº†å‡ å¤©æ—¶é—´æ•´ç†äº†ä¸€äº›èµ„æ–™ï¼Œåšä¸ªå…¥é—¨åˆ†äº«ã€‚ä¸‹é¢ä¸»è¦ä»¥**Why Recoil -> When Recoil -> How Recoil** çš„é¡ºåºå»ä»‹ç»Recoilã€‚*

#### 1.Why Recoil
å®ƒä¸ºä»€ä¹ˆå‡ºç°å‘¢ï¼Ÿ
é—®é¢˜çš„æºå¤´å¯ä»¥è¿½æº¯åˆ°Reactæ¡†æ¶æœ¬èº«ï¼Œå› ä¸ºReactè§„å®šäº†æ•°æ®çš„æµå‘æ˜¯ç”±å¤–å±‚ç»„ä»¶å‘å†…å±‚ç»„ä»¶è¿›è¡Œä¼ é€’å’Œæ›´æ–°ï¼Œç»„ä»¶çŠ¶æ€åªèƒ½ä¸å…¶ç¥–å…ˆç»„ä»¶è¿›è¡Œå…±äº«ï¼Œè¿™å¯èƒ½ä¼šå¸¦æ¥ç»„ä»¶æ ‘ä¸­å¤§é‡çš„é‡ç»˜å¼€é”€ï¼Œç»„ä»¶é—´é€šä¿¡ä¹Ÿä¼šå¾ˆä¸æ–¹ä¾¿ã€‚

è™½ç„¶Contextå¯ä»¥è§£å†³è¿™ç§é—®é¢˜ï¼Œä½†æ˜¯Contextçš„é—®é¢˜åœ¨äºï¼š
>Context can only store a single value, not an indefinite set of values each with its own consumers.(Context åªèƒ½ä¿å­˜ä¸€ä¸ªç‰¹å®šå€¼è€Œä¸æ˜¯ä¸å…¶ Consumer å…±äº«ä¸€ç»„ä¸ç¡®å®šçš„å€¼)

> è¿™ä¼šå¯¼è‡´ç»„ä»¶æ ‘é¡¶éƒ¨ç»„ä»¶ï¼ˆçŠ¶æ€ç”Ÿäº§è€…ï¼‰ä¸ç»„ä»¶æ ‘åº•éƒ¨ç»„ä»¶ï¼ˆçŠ¶æ€æ¶ˆè´¹è€…ï¼‰ä¹‹é—´çš„ä»£ç æ‹†åˆ†å˜å¾—éå¸¸å›°éš¾ã€‚

ä»¥ä¸Šæ˜¯å®˜æ–¹æ–‡æ¡£ç»™å‡ºçš„è§£é‡Šï¼Œç¬¬ä¸€æ¬¡çœ‹åˆ°æ—¶å€™æˆ‘æ˜¯è¿™æ ·çš„ğŸ˜µã€‚ç»†å“ä¹‹åï¼Œæ„Ÿè§‰å®ƒæƒ³è¡¨è¾¾çš„æ„æ€å…¶å®æ˜¯ï¼š
1.é¦–å…ˆæ˜ç™½`Context`å·¥ä½œæœºåˆ¶ï¼šå› ä¸ºæ¯å½“`Provider`çš„å€¼å‘ç”Ÿæ”¹å˜æ—¶, ä½œä¸º`Provider`åä»£çš„æ‰€æœ‰`Consumers`éƒ½ä¼šé‡æ–°æ¸²æŸ“ã€‚
2.å½“å­˜åœ¨å¤šä¸ª`Consumer`æ—¶ï¼Œä¸ºäº†é¿å…ä¸å¿…è¦çš„æ›´æ–°ï¼Œä¸ä¼šæŠŠæ‰€æœ‰`Consumers`ç”¨åˆ°çš„çŠ¶æ€éƒ½ä¸€è‚¡è„‘å¡è¿›åŒä¸€ä¸ª`Provider`ã€‚
3.æ‰€ä»¥å°±å‡ºç°äº†å¤šä¸ª`Provider-Consumer`ï¼Œä¸ºçš„å°±æ˜¯å„è‡ªç®¡ç†å„è‡ªçš„çŠ¶æ€ï¼Œäº’ä¸æ‰“æ‰°ã€‚
4.ä½†æ˜¯è¿™å°±å‡ºç°äº†å¦ä¸€ä¸ªé—®é¢˜ï¼šä»£ç è€¦åˆï¼Œæ‹†åˆ†å›°éš¾ã€‚(å®Œç»“æ’’èŠ±ğŸŒ¸)

è¨€å½’æ­£ä¼ ï¼Œä»¥ä¸Šè¿™äº›é—®é¢˜ä¿ƒè¿›äº†`Recoil`çš„è¯ç”Ÿï¼ŒåŒæ—¶ä¸ºäº†è¾¾åˆ°é«˜æ€§èƒ½çš„ç›®çš„ï¼Œéœ€è¦æ›´åŠ ç²¾ç»†åœ°æ“ä½œæ•°æ®æµï¼Œæœ€å`Recoil`è®¡åˆ’é€šè¿‡ä¸åŒäº`reduxã€mobx`çš„æ–¹å¼è§£å†³è¿™äº›é—®é¢˜ï¼š
- Flexible shared state: åœ¨ react tree ä»»æ„çš„åœ°æ–¹éƒ½èƒ½çµæ´»å…±äº« stateï¼Œå¹¶ä¿æŒé«˜æ€§èƒ½
- Derived data and queries: é«˜æ•ˆå¯é åœ°æ ¹æ®å˜åŒ–çš„ state è¿›è¡Œè®¡ç®—
- App-wide state observation: time travel debugging, æ”¯æŒ undo, æ—¥å¿—æŒä¹…åŒ–

Recoilå°±è¿™æ ·è¯ç”Ÿäº†ğŸ£ğŸ£ğŸ£ğŸ£ğŸ£ğŸ£ğŸ£


#### 2.When Recoil
æˆ‘ä»¬ä»€ä¹ˆæ—¶å€™ä½¿ç”¨å®ƒå‘¢ï¼Ÿ

æ¯”è¾ƒç°æœ‰çš„çŠ¶æ€åº“`redux` ä¸ `mobx`ï¼Œå®ƒä»¬çš„åŒºåˆ«ä¸»è¦åœ¨äºï¼š



| çŠ¶æ€ç®¡ç†åº“ | Redux | Mobx | Recoil |
| ----- | ----- | ----- | ----- |
| æµç¨‹ | è§„èŒƒ/å¤æ‚ | è‡ªç”±/ç®€å• | è§„èŒƒ/ç®€å• |
| ä¾èµ– | redux/react-redux/redux-saga | mobx/mobx-react | recoil |
| æ”¯æŒ | ç±»/å‡½æ•°ç»„ä»¶ | ç±»/å‡½æ•°ç»„ä»¶ | å‡½æ•°ç»„ä»¶ |
| å­¦ä¹ æˆæœ¬ | é«˜ | ä½ | ä½ |
| æ€æƒ³ | å‡½æ•°å¼ | å“åº”å¼ | hook |
| ç‰ˆæœ¬ | æ­£å¼ | æ­£å¼ | æµ‹è¯• |


æ‰€ä»¥åŸºäºä»¥ä¸Šåˆ†æï¼Œé¡¹ç›®åœ¨æ»¡è¶³ `Reacté¡¹ç›® && ä½¿ç”¨hook && å°å‹é¡¹ç›®`çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥è€ƒè™‘ä½¿ç”¨Recoilã€‚

#### 3.How Recoil

#####Recoilæ˜¯å¦‚ä½•å®ç°çŠ¶æ€ç®¡ç†çš„å‘¢?

è®©æˆ‘ä»¬çœ‹çœ‹ï¼Œ`Recoil`ä¸ºäº†è¾¾åˆ° **Flexible shared state** ã€ **Derived data and queries** è¿™ä¸¤ä¸ªç›®çš„å…·ä½“æ˜¯æ€ä¹ˆåšçš„ğŸ˜Šã€‚

######Shared state
æœ‰ä¸€ä¸ªåº”ç”¨åŸºäºè¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼Œå°† List ä¸­æ›´æ–°ä¸€ä¸ªèŠ‚ç‚¹ï¼Œç„¶åå¯¹åº” Canvas ä¸­çš„èŠ‚ç‚¹ä¹Ÿæ›´æ–°
![](https://segmentfault.com/img/bVcRHCF)

`Recoil`é‡‡ç”¨çš„æ–¹å¼æ˜¯åœ¨ React Tree ä¸Šåˆ›å»ºå¦ä¸€ä¸ªæ­£äº¤çš„ Treeï¼ŒæŠŠæ¯ä¸ªèŠ‚ç‚¹çš„ state æŠ½å‡ºæ¥ã€‚æ¯ä¸ª component éƒ½æœ‰å¯¹åº”å•ç‹¬çš„ä¸€ç‰‡ stateï¼Œå½“æ•°æ®æ›´æ–°çš„æ—¶å€™å¯¹åº”çš„ç»„ä»¶ä¹Ÿä¼šæ›´æ–°ã€‚Recoil æŠŠ è¿™æ¯ä¸€ç‰‡çš„æ•°æ®ç§°ä¸º Atomï¼ŒAtom æ˜¯å¯è®¢é˜…å¯å˜çš„ state å•å…ƒã€‚å¦‚å›¾æ‰€ç¤ºï¼š

![](https://segmentfault.com/img/bVcRHDi)

######Derived Data
æœ‰è¿™ä¹ˆä¸€ä¸ªåœºæ™¯éœ€è¦æ ¹æ®List è®¡ç®— totalNumã€totalCompletedNumä¹‹ç±»åŸºäºListçš„**æ´¾ç”ŸçŠ¶æ€**ã€‚

è¿™æ˜¯ä¸æ˜¯æœ‰ç‚¹ `Mobx`ä¸­çš„`@computed`é‚£å‘³å„¿äº†ğŸ¤¨ï¼ŒDerived Dataçš„å…·ä½“æ€è·¯æ˜¯é€‰å–å¤šä¸ª Atom è¿›è¡Œè®¡ç®—ï¼Œç„¶åè¿”å›ä¸€ä¸ªæ–°çš„ stateã€‚å› æ­¤åœ¨ Recoil ä¸­è®¾è®¡äº† selector è¿™æ ·çš„ API æ¥é€‰å–å¤šä¸ª Atom è¿›è¡Œè®¡ç®—ã€‚selector çš„è®¾è®¡å’Œ Proxy æŒºåƒçš„ï¼Œå±æ€§ä¸Šæœ‰ get è¿›è¡Œè¯»å–ï¼Œæœ‰ set è¿›è¡Œè®¾ç½®ï¼Œå‡½æ•°å†…éƒ¨åˆæœ‰ getï¼Œ set æ“ä½œ stateã€‚


#####é‚£æˆ‘ä»¬å¦‚ä½•ä½¿ç”¨å®ƒå‘¢ï¼Ÿ

ç›´æ¥å®è·µä¸€ä¸ªdemoå§ï¼Œä½†æ˜¯å†™demoä¹‹å‰æœ€å¥½å…ˆäº†è§£å‡ ç‚¹é‡è¦çš„æ¦‚å¿µï¼š

- ç±»ä¼¼äº`Provider` ä½¿ç”¨`Recoil`éœ€è¦åœ¨æ ¹èŠ‚ç‚¹å¤–é¢åŒ…è£¹ä¸€å±‚`<RecoilRoot/>`
- `Atom` ä»£è¡¨çŠ¶æ€ã€`Selector` ä»£è¡¨ æ´¾ç”ŸçŠ¶æ€
- å¸¸ç”¨çš„hookå‡½æ•°æœ‰ `useRecoilValue`ã€`useSetRecoilState`ã€`useRecoilState`

è¿™é‡Œç²˜å‡ è¡Œ`useRecoilState`çš„æºç ï¼Œç›¸ä¿¡å¤§å®¶å°±çŸ¥é“è¿™ä¸‰ä¸ªhookå¤§æ¦‚çš„ç”¨é€”äº†ï¼š
```js
function useRecoilState<T>(
  recoilState: RecoilState<T>,
): [T, SetterOrUpdater<T>] {
  if (__DEV__) {
    // $FlowFixMe[escaped-generic]
    validateRecoilValue(recoilState, 'useRecoilState');
  }
  return [useRecoilValue(recoilState), useSetRecoilState(recoilState)];
}
```

ä¸‹é¢å®ç°ä¸€ä¸ªå®˜æ–¹çš„ç®€æ˜“demo:
[æŸ¥çœ‹demo](https://recoil.js.cn/docs/introduction/getting-started)
```js
//App.js
import React from 'react';
import { RecoilRoot } from 'recoil';
import CharacterCounter from './pages/charCounter'

export default function App() {
  return (
    <RecoilRoot>
      <CharacterCounter />
    </RecoilRoot>
  );
}

```

```js
//charCounter.js
import { useRecoilState, useRecoilValue } from 'recoil'
import { textState, charCountState } from '../store/charCounterStore'

export default function CharacterCounter() {
    return (
        <div>
            <TextInput />
            <CharacterCount />
        </div>
    );
}

function TextInput() {
    const [text, setText] = useRecoilState(textState);
    const onChange = (e) => setText(e.target.value);
    return (
        <div>
            <input type="text" value={text} onChange={onChange} />
            è¾“å…¥æ–‡æœ¬: {text}
        </div>
    );
}

function CharacterCount() {
    const count = useRecoilValue(charCountState);
    return <>è¾“å…¥é•¿åº¦: {count}</>;
}
```
```js
//charCounterStore.js
import { atom, selector } from 'recoil';

export const textState = atom({
    key: 'textState',
    default: ''
})
export const charCountState = selector({
    key: 'charCountState',
    get: ({get})=>{
        const text = get(textState)
        return text.length;
    }
})
```

å†™å®Œè¿™ä¸ªdemoç»™æˆ‘çš„æ„Ÿè§‰å°±æ˜¯ï¼Œåªè¦ç†Ÿæ‚‰hookè¯­æ³•ï¼Œä¸Šæ‰‹Recoilç®€ç›´too EZğŸ¶ï¼Œ`useRecoilState` å¾ˆåƒ `useState`,åªä¸è¿‡ `useRecoilState` æ¥æ”¶çš„åˆå§‹åŒ–å‚æ•°æ˜¯ `atom` or `selector` ã€‚å½“ç»„ä»¶éœ€è¦ç”¨åˆ°å…±äº«çŠ¶æ€æ—¶(atom)ï¼Œåªéœ€è¦é€šè¿‡Recoil hookå¼•å…¥è¿™ä¸ªå…±äº«çŠ¶æ€å³å¯ä½¿ç”¨ï¼Œå½“atomå˜åŒ–åï¼Œæ‰€æœ‰è®¢é˜…è¿™ä¸ªatomçš„å…¶ä»–ç»„ä»¶éƒ½ä¼šåŒæ­¥è¿™ä¸ªæ•°æ®ğŸ‘ã€‚

---

æœ€åï¼Œæå‡ ç‚¹æ–‡ä¸­æ²¡æåˆ°çš„ï¼š
- Recoilå¯ä»¥å°†å¯¼èˆªè§†ä¸ºä¸€ç­‰å…¬æ°‘ï¼Œç”šè‡³å¯ä»¥å¯¹é“¾æ¥ä¸­çš„çŠ¶æ€è¿›è¡Œç¼–ç ã€‚
- Recoilæœ‰ä¸å¹¶å‘æ¨¡å¼åŠå…¶ä»– React æ–°ç‰¹æ€§å…¼å®¹çš„å¯èƒ½æ€§ã€‚
- Recoilå¯ä»¥ä½¿ç”¨Reactå†…éƒ¨çš„è°ƒåº¦æœºåˆ¶ï¼Œè¿™æ˜¯Reduxå’ŒMobxä¸æ”¯æŒçš„ã€‚